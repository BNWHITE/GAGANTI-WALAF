<!DOCTYPE html>
<html lang="wo" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Waxtaan ci Gagganti</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Gagganti';
      src: url('gagganti.ttf') format('truetype');
      font-display: swap;
    }

    body {
      font-family: 'Gagganti', sans-serif;
      background-color: #f8f8f8;
      color: #1a1a1a;
      height: 100vh;
      overflow: hidden;
      display: flex;
      direction: rtl;
    }

    .message-out {
      background-color: #e5e5ff;
      border-left: 4px solid #4B0082;
    }

    .message-in {
      background-color: #ffffff;
      border-right: 4px solid #4B0082;
    }

    .message-time {
      font-size: 0.75rem;
      color: #666;
    }

    .reaction {
      font-size: 1rem;
      margin-left: 0.5rem;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .reaction:hover {
      transform: scale(1.3);
    }

    #message-input:focus {
      outline: none;
      box-shadow: 0 0 0 2px #4B0082;
    }

    .day-divider {
      text-align: center;
      font-size: 0.8rem;
      color: #888;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div class="absolute top-2 left-2 z-50">
    <button id="themeToggle" class="bg-gray-200 text-black px-4 py-1 rounded-full">Mode Sombre</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const themeToggle = document.getElementById('themeToggle');
      const darkMode = localStorage.getItem('theme') === 'dark';
      if (darkMode) document.body.classList.add('dark');

      themeToggle.onclick = () => {
        document.body.classList.toggle('dark');
        localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        themeToggle.textContent = document.body.classList.contains('dark') ? 'Mode Clair' : 'Mode Sombre';
      };
    });
  </script>

  <script>
    const storedName = localStorage.getItem('gagganti_username') || prompt('Tapp tur wu matale :');
    const storedAvatar = localStorage.getItem('gagganti_avatar') || prompt('Entrer lien avatar (facultatif) :');
    localStorage.setItem('gagganti_username', storedName);
    localStorage.setItem('gagganti_avatar', storedAvatar);
  </script>

  <div class="w-full flex">
    <!-- (Remainder of HTML remains unchanged, except for added features to message rendering logic) -->
  </div>

  <script>
    // Modified renderMessage to handle date dividers and avatars
    let lastMessageDate = '';

    function formatDate(date) {
      const today = new Date();
      const d = new Date(date);
      if (d.toDateString() === today.toDateString()) return 'Tey';
      const yesterday = new Date();
      yesterday.setDate(today.getDate() - 1);
      if (d.toDateString() === yesterday.toDateString()) return 'D√©mb';
      return d.toLocaleDateString();
    }

    function renderMessage(msg) {
      const msgDate = new Date().toDateString();
      if (msgDate !== lastMessageDate) {
        const divider = document.createElement('div');
        divider.className = 'day-divider';
        divider.textContent = formatDate(new Date());
        el.messages.appendChild(divider);
        lastMessageDate = msgDate;
      }

      const div = document.createElement('div');
      div.className = `max-w-xl px-4 py-2 rounded-xl ${msg.outgoing ? 'message-out ml-auto text-right' : 'message-in mr-auto text-right'} relative`;
      div.innerHTML = `
        <div class="flex items-center gap-2">
          ${storedAvatar ? `<img src="${storedAvatar}" alt="avatar" class="w-6 h-6 rounded-full">` : ''}
          <div class="font-bold text-purple-600">${msg.user}</div>
        </div>
        <div class="text-lg">${msg.text}</div>
        <div class="message-time">${msg.time}</div>
        <div class="absolute bottom-0 left-2 flex gap-1">
          <span class="reaction">‚ù§Ô∏è</span>
          <span class="reaction">üòÇ</span>
          <span class="reaction">üî•</span>
        </div>`;
      el.messages.appendChild(div);
      el.messages.scrollTop = el.messages.scrollHeight;
    }

    // Search functionality (basic)
    const searchInput = document.createElement('input');
    searchInput.placeholder = 'Wut ci xibaar...';
    searchInput.className = 'absolute top-2 right-2 bg-white border border-gray-300 rounded-full px-4 py-1 text-sm z-50';
    document.body.appendChild(searchInput);
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase();
      document.querySelectorAll('#messages > div').forEach(div => {
        div.style.display = div.textContent.toLowerCase().includes(query) ? '' : 'none';
      });
    });
  </script>
</body>
</html>
