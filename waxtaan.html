<!DOCTYPE html>
<html lang="wo" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Waxtaan ci Gagganti</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Gagganti';
      src: url('gagganti.ttf') format('truetype');
      font-display: swap;
    }

    body {
      font-family: 'Gagganti', sans-serif;
      background: linear-gradient(to left, #F5F5F5, #ffffff);
      color: #1a1a1a;
      height: 100vh;
      overflow: hidden;
      display: flex;
      direction: rtl;
    }

    .message-out {
      background-color: rgba(255, 255, 255, 0.9);
      border-left: 4px solid #4B0082;
    }

    .message-in {
      background-color: rgba(230, 230, 230, 0.9);
      border-right: 4px solid #4B0082;
    }

    .message-time {
      font-size: 0.75rem;
      color: #666;
    }

    .sticker:hover {
      transform: scale(1.2);
    }

    .reaction {
      font-size: 1rem;
      margin-left: 0.5rem;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .reaction:hover {
      transform: scale(1.3);
    }

    #message-input:focus {
      outline: none;
      box-shadow: 0 0 0 2px #4B0082;
    }
  </style>
</head>
<body>
  <div class="w-full flex">
    <!-- Sidebar -->
    <aside class="hidden md:flex flex-col w-80 bg-white border-l border-purple-600 shadow-md">
      <div class="p-4 bg-purple-800 text-white text-center">
        <h3 class="text-lg font-bold"><i class="fas fa-users"></i> Niti Ã±i</h3>
      </div>
      <div id="userList" class="flex-1 overflow-y-auto p-4 space-y-2">
        <!-- Liste des utilisateurs -->
      </div>
      <div class="p-4 border-t border-purple-600">
        <button id="inviteBtn" class="w-full bg-purple-600 text-white rounded-xl py-2 font-bold hover:bg-purple-700 transition">
          <i class="fas fa-share"></i> YÃ³nnee lien
        </button>
      </div>
    </aside>

    <!-- Zone principale -->
    <main class="flex-1 flex flex-col relative">
      <!-- En-tÃªte -->
      <header class="flex items-center justify-between p-4 bg-purple-700 text-white">
        <button id="menuBtn" class="md:hidden text-white text-xl"><i class="fas fa-bars"></i></button>
        <h2 class="text-xl font-bold">Waxtaan</h2>
        <div class="flex gap-4">
          <button id="pollBtn" class="text-white text-xl"><i class="fas fa-poll"></i></button>
          <button id="stickerBtn" class="text-white text-xl"><i class="far fa-smile"></i></button>
        </div>
      </header>

      <!-- Messages -->
      <section id="messages" class="flex-1 overflow-y-auto p-4 space-y-4" style="background-image: url('pattern-light.svg'); background-size: cover; background-repeat: repeat;">
        <!-- Messages dynamiques -->
      </section>

      <!-- Indicateur de frappe -->
      <div id="typingIndicator" class="px-4 text-purple-600 italic text-sm"></div>

      <!-- EntrÃ©e message -->
      <div class="p-4 border-t border-purple-600 bg-white flex items-center gap-2">
        <button id="attachBtn" class="text-purple-600 text-xl"><i class="fas fa-paperclip"></i></button>
        <input id="message-input" placeholder="Bindal xibaar bi..." class="flex-1 bg-gray-100 text-black rounded-full px-4 py-2" />
        <button id="send-btn" class="text-purple-600 text-xl"><i class="fas fa-paper-plane"></i></button>
      </div>

      <!-- Stickers -->
      <div id="stickersPanel" class="absolute bottom-28 right-4 bg-white border border-purple-600 rounded-xl p-4 grid grid-cols-4 gap-2 hidden z-50 shadow-md">
        <div class="sticker text-2xl cursor-pointer">ğŸ‘‹</div>
        <div class="sticker text-2xl cursor-pointer">ğŸ˜‚</div>
        <div class="sticker text-2xl cursor-pointer">â¤ï¸</div>
        <div class="sticker text-2xl cursor-pointer">ğŸ‘</div>
        <div class="sticker text-2xl cursor-pointer">ğŸ™</div>
        <div class="sticker text-2xl cursor-pointer">ğŸ‡¸ğŸ‡³</div>
        <div class="sticker text-2xl cursor-pointer">ğŸŒ</div>
        <div class="sticker text-2xl cursor-pointer">âœ¨</div>
      </div>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let username = '';

    while (!username) {
      username = prompt('Tapp tur wu matale :').trim();
    }

    const el = {
      userList: document.getElementById('userList'),
      messages: document.getElementById('messages'),
      input: document.getElementById('message-input'),
      sendBtn: document.getElementById('send-btn'),
      typing: document.getElementById('typingIndicator'),
      stickers: document.getElementById('stickersPanel'),
      stickerBtn: document.getElementById('stickerBtn'),
      inviteBtn: document.getElementById('inviteBtn'),
      pollBtn: document.getElementById('pollBtn'),
    };

    el.sendBtn.onclick = sendMessage;
    el.input.oninput = () => socket.emit('typing', username);
    el.input.onkeypress = e => e.key === 'Enter' && sendMessage();
    el.stickerBtn.onclick = () => el.stickers.classList.toggle('hidden');
    el.inviteBtn.onclick = () => {
      navigator.clipboard.writeText(window.location.href).then(() => alert('Lien bi nÃ pp na!'));
    };
    el.pollBtn.onclick = () => {
      const q = prompt('Lii laaj bi:');
      if (q) {
        const opts = prompt('TÃ nn yi ak vigule:').split(',');
        socket.emit('message', {
          user: 'SystÃ¨me',
          text: `SONDAGE: ${q}\n${opts.map((o,i)=>`${i+1}. ${o.trim()}`).join('\n')}`,
          time: getTime()
        });
      }
    };

    document.querySelectorAll('.sticker').forEach(sticker => {
      sticker.onclick = () => {
        const msg = {
          user: username,
          text: sticker.textContent,
          time: getTime(),
          isSticker: true,
          outgoing: true
        };
        socket.emit('message', msg);
        renderMessage(msg);
        el.stickers.classList.add('hidden');
      };
    });

    function sendMessage() {
      const text = el.input.value.trim();
      if (!text) return;
      const msg = {
        user: username,
        text,
        time: getTime(),
        outgoing: true
      };
      socket.emit('message', msg);
      renderMessage(msg);
      el.input.value = '';
    }

    function renderMessage(msg) {
      const div = document.createElement('div');
      div.className = `max-w-xl px-4 py-2 rounded-xl ${msg.outgoing ? 'message-out ml-auto text-right' : 'message-in mr-auto text-right'} relative`;
      div.innerHTML = `
        <div class="font-bold text-purple-600">${msg.user}</div>
        <div class="text-lg">${msg.text}</div>
        <div class="message-time">${msg.time}</div>
        <div class="absolute bottom-0 left-2 flex gap-1">
          <span class="reaction">â¤ï¸</span>
          <span class="reaction">ğŸ˜‚</span>
          <span class="reaction">ğŸ”¥</span>
        </div>`;
      el.messages.appendChild(div);
      el.messages.scrollTop = el.messages.scrollHeight;
    }

    function getTime() {
      return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    socket.on('connect', () => {
      socket.emit('join', username);
    });

    socket.on('message', msg => {
      if (msg.user !== username) renderMessage(msg);
    });

    socket.on('typing', user => {
      if (user !== username) {
        el.typing.textContent = `${user} ngi bind...`;
        setTimeout(() => {
          el.typing.textContent = '';
        }, 3000);
      }
    });

    socket.on('userList', users => {
      el.userList.innerHTML = users.map(user => `<div class='flex items-center gap-2'><i class='fas fa-user text-purple-600'></i> ${user}</div>`).join('');
    });
  </script>
</body>
</html>
